<script src="aws-iot-browser-all.js"></script>
<script src="aws-sdk-2.2.22.min.js"></script>
<script src="google-maps.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&key=AIzaSyDwdBNCbhvFNMc2CMwBfWj84VDKb9A32Io&signed_in=true&libraries=geometry,places&callback=initMap"
 async defer></script>
<script src="iot.js"></script>
<script src="util.js"></script>
<script src="jquery-2.1.4.min.js"></script>
<script>

consolelog('start');
var browser = require('browser');

var thingName = null;

AWS.config.region = 'eu-west-1'; // Region
AWS.config.credentials = new AWS.CognitoIdentityCredentials({
		IdentityPoolId : 'eu-west-1:fa4f4221-3a4e-4f55-b62f-41da26ba0f9e',
	});

AWS.config.credentials.get(function (err) {
	if (err == null) {
		consolelog(AWS.config.credentials);
		connect();
	} else {
		consolelog(err);
	}
});

var DEBUG_APP = true;
var DEBUG = false;
var SIMULATE_MOVEMENT = false;
var threshold_accuracy = 9999999;
var myThing = null;
var myPosition = null;
var map = null;

var WATCH_OWN_POSITION = true;

var getposition_params = {
	//enableHighAccuracy : false,
	//timeout : 5000,
	//maximumAge : 10000
};

function watchPosition() {
	// Try HTML5 geolocation.

	if (SIMULATE_MOVEMENT) {
		if (navigator.geolocation) {
			watch_id = navigator.geolocation.getCurrentPosition(
					processOwnPosition, onError, getposition_params);
		} else {
			alert('no navigator.geolocation');
		}
	} else {
		consolelog('fetching geolocation');
		if (navigator.geolocation) {
			watch_id = navigator.geolocation.watchPosition(
					processOwnPosition, onError, getposition_params);
		} else {
			alert('no navigator.geolocation');
		}
	}
}

function onProgress() {}

function onError(err) {
		console.warn('ERROR(' + err.code + '): ' + err.message);
	}

	
function messageFromOther(topic, payload, owner, isown) {
	if (isown) return;
	consolelog(payload.toString());
	var data = JSON.parse(payload);
	if (data.position) {
		processPosition(data.position, null, 
			function (reason, newPosition) {
			if (reason == 'new')
			{
			consolelog('other position: ' + newPosition); 
			
			showPositionOnMap(owner, newPosition, null);
			}
			});
		}
}
	
function processOwnPosition(position) {
	processPosition(position, myPosition,
		function (reason, newPosition) {
		if (reason == 'new')
		{
			consolelog('new own position: ' + newPosition); 
			myPosition = newPosition;
			publishPosition();
			showPositionOnMap(-1, myPosition, marks[0]);
		}
	});
}
	
function processPosition(position, positionPrev, callback, snapToRoad, simulate_driving) {
		if (position == null)
			return;

		consolelog('new position fetched, processing')
			
		position = assoc(position);

		/* simulate movement */
		if (true) {
			navigator.geolocation.clearWatch(watch_id);
			/* simulate movement */
			position.coords.latitude = position.coords.latitude + 0.00025;
			position.coords.longitude = position.coords.longitude + 0.00015;
			//pos.lng = pos.lng + 0.0001 * path.length;
		}

		var pos = {
			lat : position.coords.latitude,
			lng : position.coords.longitude
		};

		/* check for accuracy */
		if (positionPrev == null || SIMULATE_MOVEMENT ||
			position.coords.accuracy < threshold_accuracy) {

			/* check for distance from previous pos */
			if (positionPrev != null &&
				distance(
					pos.lat, pos.lng,
					positionPrev.coords.latitude, positionPrev.coords.longitude) < 0.005) {
				consolelog('similar position');
				callback('similar');
				return;
			}

			if (snapToRoad) {
				notifyBackEnd(position, true, simulate_driving, processBackendResponse);
			}
			else
			{
				callback('new', position);
			}

		} else {
			consolelog('not accurate position');
			callback('not_accurate', position);
		}
}


function notifyBackEnd(position, snapToRoad, simulate_driving, callback) {
	
	lambda_options = position;
	lambda_options.snapToRoad = simulate_driving == null && snapToRoad;
	lambda_options.sim = simulate_driving;
	
	var params = {
		FunctionName : 'backend1',
		Payload : JSON.stringify(lambda_options)
	};
	
	var date1 = new Date();
	
	lambda.invoke(params, function (err, data) {
		if (err) {
			consolelog(err, err.stack);
		} else {
			var date2 = new Date();
			//console.log(data);
			//console.log(Math.round(date2-date1));
			var userdata = JSON.parse(data.Payload);
			callback(userdata);
		}
	});
}

function initmap() {
}

function publishPosition() {
	var payload = JSON.stringify({position: myPosition});
	consolelog('payload length: ' + (encodeURI(payload).split(/%..|./).length - 1));
	deviceOp(myThing, 'publish', ['/all/positions/' + thingName, payload]);
}
	
function start(thingsShadows) {
/* register thingName */
//thingShadows.register(
//	thingName, { ignoreDeltas: false, operationTimeout: operationTimeout } );
myThing = thingsShadows;
deviceOp(myThing, 'subscribe', ['/all/positions/+', null]);
//thingsShadows.subscribe('/all/positions/+');

init_geolocation();

}

function init_geolocation() {
	if (WATCH_OWN_POSITION) {
		watchPosition();
	}
}

function connect() {

thingShadows = browser.thingShadow({
	keyPath: null,
	certPath: null,
	caPath: null,
	reconnectPeriod: null,
	protocol:'wss', 
	region:'eu-west-1', 
	host: 'a2kbykj60bmbfx.iot.eu-west-1.amazonaws.com', 
	clientId: AWS.config.credentials.identityId,
	//awsAccessId: 'AKIAJOROMJTMN3HGGUKA',
	awsAccessId: AWS.config.credentials.accessKeyId,
	//awsSecretKey: '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',
	awsSecretKey: AWS.config.credentials.secretAccessKey,
	awsSessionToken: AWS.config.credentials.sessionToken,
	testMode: 1 },
	AWS.config.credentials.identityId);

thingName = AWS.config.credentials.identityId;

set_events(thingShadows, start, messageFromOther, connect);
}
</script>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 5px;
      }
      #map {
        height: 80%;
		width: 100%;
      }
	  #top {
	  padding-top: 5px;
	  padding-bottom: 10px;
	  }
    </style>
<body>
<div id='top'></div>
<div id='map'></div>
<script>
$('#top').append(button('publish_button', 'publishPosition()', 'Publish Position'));
</script>
</body>	