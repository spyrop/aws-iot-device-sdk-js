<script src="aws-iot-browser-all.js"></script>
<script src="aws-sdk-2.2.22.min.js"></script>
<script src="iot.js"></script>
<script>
console.log('start');
var browser = require('browser');

var thingName = null;

AWS.config.region = 'eu-west-1'; // Region
AWS.config.credentials = new AWS.CognitoIdentityCredentials({
		IdentityPoolId : 'eu-west-1:fa4f4221-3a4e-4f55-b62f-41da26ba0f9e',
	});

AWS.config.credentials.get(function (err) {
	if (err == null) {
		console.log(AWS.config.credentials);
		connect();
	} else {
		console.log(err);
	}
});

var DEBUG = false

function start(thingsShadows) {
/* register thingName */
//thingShadows.register(
//	thingName, { ignoreDeltas: false, operationTimeout: operationTimeout } );

deviceOp(thingsShadows, 'subscribe', ['/all/positions/+', null]);
//thingsShadows.subscribe('/all/positions/+');

//window.setInterval(function(){
//	var payload = { coords: { lat: 20.0, lng: 15.0 } };
//	deviceOp(thingsShadows, 'publish', ['/all/positions/' + thingName, JSON.stringify(payload)]);
//}, 5000);
}

function onMessage(topic, payload, owner, isown) {
	if (isown) return;
	console.log(payload.toString());
}

function connect() {

thingShadows = browser.thingShadow({
	keyPath: null,
	certPath: null,
	caPath: null,
	reconnectPeriod: null,
	protocol:'wss', 
	region:'eu-west-1', 
	host: 'a2kbykj60bmbfx.iot.eu-west-1.amazonaws.com', 
	clientId: AWS.config.credentials.identityId,
	//awsAccessId: 'AKIAJOROMJTMN3HGGUKA',
	awsAccessId: AWS.config.credentials.accessKeyId,
	//awsSecretKey: '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',
	awsSecretKey: AWS.config.credentials.secretAccessKey,
	awsSessionToken: AWS.config.credentials.sessionToken,
	testMode: 1 },
	AWS.config.credentials.identityId);

thingName = AWS.config.credentials.identityId;
	
set_events(thingShadows, start, onMessage);
}
</script>